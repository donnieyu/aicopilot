### [Mode A] Quick Start 요청 (자연어 -> 리스트 -> 맵)
# 사용자가 처음 자연어로 프로세스를 요청하는 시나리오입니다.
# 1단계(Outliner)와 2단계(Transformer)가 순차적으로 실행됩니다.
POST http://localhost:8080/api/copilot/start
Content-Type: application/json

{
  "userPrompt": "직원 채용 프로세스를 만들어줘. 지원자가 이력서를 제출하면 HR이 검토하고, 합격하면 면접을 보고, 최종 합격하면 입사 처리를 하는 과정이야. 중간에 불합격하면 통보해야 해."
}

> {%
    client.global.set("modeA_JobId", response.body.jobId);
    client.log("Mode A Job ID saved: " + response.body.jobId);
%}

### [Mode A] 상태 조회 (Polling)
# 위 요청 실행 후 반복해서 상태를 확인하세요.
# 단계 변화: 1단계(리스트 작성) -> 2단계(맵 변환 & 자가수정) -> 완료
GET http://localhost:8080/api/copilot/status/{{modeA_JobId}}

---

### [Mode B] Transformation 요청 (리스트 JSON -> 맵)
# 프론트엔드(Outliner UI)에서 사용자가 직접 단계를 편집한 뒤, '맵 생성' 버튼을 눌렀다고 가정한 시나리오입니다.
# ProcessDefinition JSON을 직접 전송합니다.
POST http://localhost:8080/api/copilot/transform
Content-Type: application/json

{
  "topic": "Human Resources",
  "steps": [
    {
      "stepId": "1",
      "name": "Submit Request",
      "role": "Employee",
      "description": "The employee submits a request for leave, reimbursement, or any other HR-related matter through the designated HR system or form.",
      "type": "ACTION"
    },
    {
      "stepId": "2",
      "name": "Review Request",
      "role": "HR Manager",
      "description": "The HR manager reviews the submitted request for completeness and compliance with company policies.",
      "type": "ACTION"
    },
    {
      "stepId": "3",
      "name": "Decision on Request",
      "role": "HR Manager",
      "description": "The HR manager decides whether to approve or reject the request based on the review.",
      "type": "DECISION"
    },
    {
      "stepId": "4",
      "name": "Notify Employee",
      "role": "HR Manager",
      "description": "The HR manager communicates the decision to the employee, providing details on the approval or reasons for rejection.",
      "type": "ACTION"
    }
  ]
}

> {%
    client.global.set("modeB_JobId", response.body.jobId);
    client.log("Mode B Job ID saved: " + response.body.jobId);
%}

### [Mode B] 상태 조회 (Polling)
# Mode B는 1단계 없이 바로 2단계(Transformation)부터 시작합니다.
GET http://localhost:8080/api/copilot/status/{{modeB_JobId}}

---

### [Phase 3] 실시간 AI 제안 (Suggestion)
# 특정 노드(포커스 노드) 다음 단계에 무엇이 올지, 데이터 바인딩은 어떻게 할지 물어봅니다.
POST http://localhost:8080/api/copilot/suggest
Content-Type: application/json

{
  "focusNodeId": "node_review_resume",
  "currentGraphJson": "{ \"nodes\": [ { \"id\": \"node_review_resume\", \"type\": \"USER_TASK\", \"label\": \"Resume Review\", \"data\": { \"outputVariables\": [\"resume_score\", \"candidate_email\"] } } ] }"
}

### [Shadow Architect] 백그라운드 분석 요청 (POST /analyze)
# 시나리오: 사용자가 '휴가 승인' 노드를 만들었지만, 승인 경로만 연결하고 반려 경로를 연결하지 않음.
# 기대 결과: AI가 "반려 경로가 누락되었습니다"라는 ERROR 또는 WARNING을 반환해야 함.
POST http://localhost:8080/api/copilot/analyze
Content-Type: application/json

{
  "nodes": [
    {
      "id": "node_start",
      "type": "START",
      "label": "Start"
    },
    {
      "id": "node_submit",
      "type": "USER_TASK",
      "label": "휴가 신청서 작성",
      "data": { "nextActivityId": "node_approve" }
    },
    {
      "id": "node_approve",
      "type": "USER_TASK",
      "label": "팀장 승인",
      "data": {
        "configuration": { "isApproval": true }
      }
    },
    {
      "id": "node_end",
      "type": "END",
      "label": "End"
    }
  ],
  "edges": [
    { "source": "node_start", "target": "node_submit" },
    { "source": "node_submit", "target": "node_approve" },
    { "source": "node_approve", "target": "node_end", "label": "Approved" }
  ]
}

### [Shadow Architect] 구조 분석 요청 (Analyze API Test)
POST http://localhost:8080/api/copilot/analyze
Content-Type: application/json

{
  "nodes": [
    { "id": "node_1", "type": "USER_TASK", "label": "Task 1" }
  ],
  "edges": []
}

### Create a travel expense reimbursement form. It should include fields for destination, travel dates (start/end), total amount, currency, and receipt upload.
### [New] 폼 생성 제안 (Suggest Form)
# 사용자의 자연어 요청을 기반으로 폼 정의를 생성합니다.
POST http://localhost:8080/api/copilot/suggest/form
Content-Type: application/json

{
  "prompt": "New form 2."
}

### [New] Data Auto-Discovery Test
# 시나리오: 비용 처리 프로세스(Expense Report)의 구조만 있고 데이터 엔티티는 없는 상태.
# 기대 결과: AI가 'ExpenseAmount', 'ReceiptImage', 'Description' 등의 필드를 제안해야 함.
POST http://localhost:8080/api/copilot/suggest/data-model/auto-discovery
Content-Type: application/json

{
  "processContext": {
    "nodes": [
      { "id": "node_start", "type": "START", "label": "Start" },
      { "id": "node_submit", "type": "USER_TASK", "label": "Submit Expense Report", "description": "Employee submits travel expenses for reimbursement." },
      { "id": "node_manager_review", "type": "USER_TASK", "label": "Manager Approval", "description": "Manager reviews the amount and receipt." },
      { "id": "node_gateway", "type": "EXCLUSIVE_GATEWAY", "label": "Amount Check (> $1000)" },
      { "id": "node_pay", "type": "SERVICE_TASK", "label": "Process Payment", "description": "Finance system processes the payment." },
      { "id": "node_end", "type": "END", "label": "End" }
    ],
    "edges": [
      { "source": "node_start", "target": "node_submit" },
      { "source": "node_submit", "target": "node_manager_review" },
      { "source": "node_manager_review", "target": "node_gateway" }
    ]
  },
  "existingEntities": []
}

### [New] Form Auto-Discovery Test
# 시나리오: 휴가 신청 프로세스는 정의되어 있고 데이터도 존재하지만, 폼(Form)이 아직 없는 상태.
# 기대 결과: 'Submit Leave Request' 단계에 맞는 폼을 기존 데이터(StartDate, Reason 등)를 매핑하여 제안해야 함.
POST http://localhost:8080/api/copilot/suggest/form/auto-discovery
Content-Type: application/json

{
  "processContext": {
    "nodes": [
      { "id": "node_start", "type": "START", "label": "Start" },
      { "id": "node_submit", "type": "USER_TASK", "label": "Submit Leave Request", "description": "Employee requests time off." },
      { "id": "node_approve", "type": "USER_TASK", "label": "Manager Approval", "description": "Manager approves or rejects." },
      { "id": "node_end", "type": "END", "label": "End" }
    ],
    "edges": [
      { "source": "node_start", "target": "node_submit" },
      { "source": "node_submit", "target": "node_approve" },
      { "source": "node_approve", "target": "node_end" }
    ]
  },
  "existingEntities": [
    { "alias": "StartDate", "type": "date", "description": "Leave start date", "sourceNodeId": "node_submit" },
    { "alias": "EndDate", "type": "date", "description": "Leave end date", "sourceNodeId": "node_submit" },
    { "alias": "Reason", "type": "string", "description": "Reason for leave", "sourceNodeId": "node_submit" },
    { "alias": "LeaveType", "type": "lookup", "description": "Type of leave (Annual, Sick)", "sourceNodeId": "node_submit", "lookupData": { "name": "Leave Type", "lookupItems": [{"value": "AL", "label": "Annual"}, {"value": "SL", "label": "Sick"}] } }
  ],
  "existingForms": []
}

### [New] Fix Process Graph Test
# 시나리오: 'MISSING_OUTPUT' 에러를 수정하는 요청입니다.
# 'Review Request' 노드에서 나가는 연결선이 없는 상황을 가정합니다.
# 기대 결과: AI가 'Review Request' 노드에서 다음 노드(예: 'Notify Employee' 또는 'End')로 연결하는 엣지를 추가해야 합니다.
POST http://localhost:8080/api/copilot/analyze/fix
Content-Type: application/json

{
  "graphSnapshot": {
    "nodes": [
      {
        "id": "lane_employee",
        "type": "SWIMLANE",
        "data": {
          "label": "Employee",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "id": "lane_manager",
        "type": "SWIMLANE",
        "data": {
          "label": "Manager",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 700,
          "y": 0
        }
      },
      {
        "id": "lane_finance_team",
        "type": "SWIMLANE",
        "data": {
          "label": "Finance Team",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 1400,
          "y": 0
        }
      },
      {
        "id": "node_1_form",
        "type": "USER_TASK",
        "data": {
          "id": "node_1_form",
          "type": "USER_TASK",
          "label": "Submit Request",
          "swimlaneId": "lane_employee",
          "description": "The employee prepares and submits a financial request or document for review, ensuring all necessary information is included.",
          "configuration": {
            "configType": "userTask",
            "participantRole": "Employee",
            "formKey": "submitRequestForm",
            "isApproval": false,
            "dueDuration": "PT2H",
            "templateId": "template_submit_request",
            "subject": "Financial Request Submission",
            "retryCount": 1,
            "priority": "normal",
            "defaultNextActivityId": "node_2_form",
            "conditions": []
          },
          "inputMapping": {},
          "position": {},
          "nextActivityId": "node_2_form",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 250,
          "y": 220
        }
      },
      {
        "id": "node_2_form",
        "type": "USER_TASK",
        "data": {
          "id": "node_2_form",
          "type": "USER_TASK",
          "label": "Review Request",
          "swimlaneId": "lane_manager",
          "description": "The manager reviews the submitted request for completeness and accuracy, checking against company policies and budget constraints.",
          "configuration": {
            "configType": "userTask",
            "participantRole": "Manager",
            "formKey": "reviewRequestForm",
            "isApproval": false,
            "dueDuration": "PT2H",
            "templateId": "template_review_request",
            "subject": "Review Financial Request",
            "retryCount": 1,
            "priority": "normal",
            "defaultNextActivityId": "node_3_gateway",
            "conditions": []
          },
          "inputMapping": {},
          "position": {},
          "nextActivityId": "node_3_gateway",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 730,
          "y": 160
        }
      },
      {
        "id": "node_3_gateway",
        "type": "EXCLUSIVE_GATEWAY",
        "data": {
          "id": "node_3_gateway",
          "type": "EXCLUSIVE_GATEWAY",
          "label": "Approve/Reject Request",
          "swimlaneId": "lane_manager",
          "description": "The manager makes a decision to either approve or reject the request based on the review findings.",
          "configuration": {
            "configType": "gateway",
            "participantRole": "Manager",
            "formKey": null,
            "isApproval": false,
            "dueDuration": null,
            "templateId": null,
            "subject": null,
            "retryCount": 0,
            "priority": null,
            "defaultNextActivityId": null,
            "conditions": [
              {
                "expression": "Approve",
                "targetActivityId": "node_4_form"
              },
              {
                "expression": "Reject",
                "targetActivityId": "node_4_reject"
              }
            ]
          },
          "inputMapping": {},
          "position": {},
          "nextActivityId": null,
          "layoutDirection": "LR"
        },
        "position": {
          "x": 1010,
          "y": 160
        }
      },
      {
        "id": "node_4_form",
        "type": "USER_TASK",
        "data": {
          "id": "node_4_form",
          "type": "USER_TASK",
          "label": "Notify Employee",
          "swimlaneId": "lane_manager",
          "description": "The manager communicates the decision to the employee, providing feedback if the request is rejected.",
          "configuration": {
            "configType": "userTask",
            "participantRole": "Manager",
            "formKey": "notifyEmployeeForm",
            "isApproval": false,
            "dueDuration": "PT1H",
            "templateId": "template_notify_employee",
            "subject": "Financial Request Decision",
            "retryCount": 1,
            "priority": "normal",
            "defaultNextActivityId": "node_5_form",
            "conditions": []
          },
          "inputMapping": {},
          "position": {},
          "nextActivityId": "node_5_form",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 1170,
          "y": 150
        }
      },
      {
        "id": "node_4_reject",
        "type": "USER_TASK",
        "data": {
          "id": "node_4_reject",
          "type": "USER_TASK",
          "label": "Reject Notification",
          "swimlaneId": "lane_manager",
          "description": "The manager notifies the employee that the request has been rejected, prompting for resubmission.",
          "configuration": {
            "configType": "userTask",
            "participantRole": "Manager",
            "formKey": "rejectNotificationForm",
            "isApproval": false,
            "dueDuration": "PT1H",
            "templateId": "template_reject_notification",
            "subject": "Financial Request Rejection",
            "retryCount": 1,
            "priority": "normal",
            "defaultNextActivityId": "node_1_form",
            "conditions": []
          },
          "inputMapping": {},
          "position": {},
          "nextActivityId": "node_1_form",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 1170,
          "y": 290
        }
      },
      {
        "id": "node_5_form",
        "type": "USER_TASK",
        "data": {
          "id": "node_5_form",
          "type": "USER_TASK",
          "label": "Process Approved Request",
          "swimlaneId": "lane_finance_team",
          "description": "If approved, the finance team processes the request, ensuring that funds are allocated and necessary documentation is completed.",
          "configuration": {
            "configType": "userTask",
            "participantRole": "Finance Team",
            "formKey": "processApprovedRequestForm",
            "isApproval": false,
            "dueDuration": "PT3H",
            "templateId": "template_process_approved_request",
            "subject": "Processing Approved Financial Request",
            "retryCount": 1,
            "priority": "high",
            "defaultNextActivityId": "node_end",
            "conditions": []
          },
          "inputMapping": {},
          "position": {},
          "nextActivityId": "node_end",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 1650,
          "y": 150
        }
      },
      {
        "id": "node_start",
        "type": "START",
        "data": {
          "label": "Start",
          "swimlaneId": "lane_employee",
          "layoutDirection": "LR"
        },
        "position": {
          "x": -150,
          "y": 210
        }
      },
      {
        "id": "node_end_point",
        "type": "END",
        "data": {
          "label": "End",
          "swimlaneId": "lane_finance_team",
          "layoutDirection": "LR"
        },
        "position": {
          "x": 2200,
          "y": 210
        }
      }
    ],
    "edges": [
      {
        "id": "e-node_1_form-node_2_form",
        "source": "node_1_form",
        "target": "node_2_form"
      },
      {
        "id": "e-node_2_form-node_3_gateway",
        "source": "node_2_form",
        "target": "node_3_gateway"
      },
      {
        "id": "e-node_3_gateway-node_4_form-0",
        "source": "node_3_gateway",
        "target": "node_4_form",
        "label": "Approve"
      },
      {
        "id": "e-node_3_gateway-node_4_reject-1",
        "source": "node_3_gateway",
        "target": "node_4_reject",
        "label": "Reject"
      },
      {
        "id": "e-node_4_form-node_5_form",
        "source": "node_4_form",
        "target": "node_5_form"
      },
      {
        "id": "e-node_4_reject-node_1_form",
        "source": "node_4_reject",
        "target": "node_1_form"
      },
      {
        "id": "e-start-node_1_form",
        "source": "node_start",
        "target": "node_1_form"
      },
      {
        "id": "e-node_5_form-node_end_point",
        "source": "node_5_form",
        "target": "node_end_point"
      }
    ]
  },
  "error": {
    "targetNodeId": "node_3_gateway",
    "severity": "ERROR",
    "type": "business_logic",
    "message": "The approval process does not have a clear rejection path for the employee.",
    "suggestion": "Ensure that the rejection path is clearly defined and communicated to the employee."
  }
}